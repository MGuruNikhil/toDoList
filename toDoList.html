<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To Do List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
</head>

<body>
    <main>
        <div class="container mt-5 col-6">
            <div class="input-group mb-3">
                <input id="inp" type="text" class="form-control" placeholder="Recipient's username"
                    aria-label="Recipient's username" aria-describedby="button-addon2">
                <button id="add_btn" class="btn btn-outline-secondary btn-success" style="color: white;" type="button"
                    id="button-addon2">save</button>
            </div>
            <ul id="parentList" class="list-group">
            </ul>
        </div>
        <br>
        <center><button id="logout" type="button" class="btn btn-primary">Log Out</button></center>
        <br>
        <center><button id="myUid" type="button" class="btn btn-info">My uid</button></center>
    </main>
    <script type="module">
        import app from "./firebaseconfig.js";
        import { getDatabase, ref, push, set, remove, onChildAdded, onChildChanged, onChildRemoved, update } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-auth.js";
        const auth = getAuth(app);
        var userId;
        var toDoListRef;
        setPersistence(auth, browserLocalPersistence)
            .then(() => {
                // Now set up your auth state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        toDoListRef = ref(db, "users/" + userId);
                        onChildAdded(toDoListRef, (snapshot) => {
                            const newItem = snapshot.val();
                            renderToDoItem(newItem, snapshot.key);
                        });
                    } else {
                        window.location.href = "auth.html";
                    }
                });
            })
            .catch((error) => {
                console.log(error);
            });
        // onAuthStateChanged(auth, (user) => {
        //     if (user) {
        //         userId = user.uid;
        //         toDoListRef = ref(db, "users/" + userId);
        //     } else {
        //         window.location.href = "auth.html";
        //     }
        // });
        const db = getDatabase(app);

        const logOut = document.getElementById("logout");
        logOut.addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = "auth.html";
            }).catch((error) => {
                console.log(error);
            });
        });

        const myUid = document.getElementById("myUid");
        myUid.addEventListener('click', () => {
            alert("Your uid is " + userId);
        });

        function renderToDoItem(item, itemKey) {
            const parentList = document.getElementById('parentList');
            const newListItem = document.createElement('li');
            newListItem.classList.add("list-group-item");
            newListItem.innerHTML = `
                <h3 class="flex-grow-1">${item.text}</h3>
                <button class="btn btn-warning mx-3 edit-btn">edit</button>
                <button class="btn btn-danger delete-btn">delete</button>
            `;
            newListItem.setAttribute('data-key', itemKey);
            parentList.appendChild(newListItem);
        }
        function updateToDoItem(itemKey, updatedItem) {
            const listItem = document.querySelector(`li[data-key="${itemKey}"]`);
            if (listItem) {
                listItem.querySelector('h3').textContent = updatedItem.text;
            }
        }
        function removeToDoItem(itemKey) {
            const listItem = document.querySelector(`li[data-key="${itemKey}"]`);
            if (listItem) {
                listItem.remove();
            }
        }
        let cbtn = document.getElementById('add_btn');
        cbtn.addEventListener('click', addChapter);
        function addChapter(e) {
            let currentBtn = e.currentTarget;
            let currentInput = document.getElementById('inp');
            let currentChapter = currentInput.value;
            if (currentChapter == "") {
                alert('Empty entries are not allowed');
                return;
            }

            const newChapterKey = push(toDoListRef);
            set(newChapterKey, {
                text: currentChapter
            });
            currentInput.value = "";
            // let newIteam=document.createElement('li');
            // newIteam.classList.add("list-group-item");
            // newIteam.innerHTML=`<h3 class="flex-grow-1">${currentChapter}</h3> <button class="btn btn-warning mx-3 edit-btn">edit</button><button class="btn btn-danger delete-btn">delete</button>`

            // let parentList=document.getElementById('parentList');
            // parentList.appendChild(newIteam);
            parentList.innerHTML = ""
            onChildAdded(toDoListRef, (snapshot) => {
                const newItem = snapshot.val();
                renderToDoItem(newItem, snapshot.key);
            });
        }
        document.getElementById('parentList').addEventListener('click', function (e) {
            if (e.target.classList.contains('edit-btn')) {
                const newText = prompt("Enter new text");
                if (newText !== null) {
                    const listItem = e.target.parentElement;
                    const updatedText = newText.trim();
                    if (updatedText !== "") {
                        // Update the edited item in Firebase Realtime Database
                        const itemKey = listItem.getAttribute('data-key');
                        // const userId = auth.currentUser.uid;
                        if (userId) {
                            set(ref(db, 'users/' + userId + '/' + itemKey), {
                                text: updatedText
                            })
                                .then(() => {
                                    console.log("Edited successfully");
                                })
                                .catch((error) => {
                                    console.log(error);
                                });
                            parentList.innerHTML = ""
                            onChildAdded(toDoListRef, (snapshot) => {
                                const newItem = snapshot.val();
                                renderToDoItem(newItem, snapshot.key);
                            });
                        }
                    } else {
                        alert('Empty entries are not allowed');
                    }
                }
            }
        });
        document.getElementById('parentList').addEventListener('click', function (e) {
            if (e.target.classList.contains('delete-btn')) {
                const listItem = e.target.parentElement;


                const itemKey = listItem.getAttribute('data-key');

                // Remove the item from Firebase Realtime Database
                // const userId = auth.currentUser.uid;
                if (userId) {
                    remove(ref(db, 'users/' + userId + '/' + itemKey))
                        .then(function () {
                            // Remove the item from the UI
                            listItem.remove();
                        })
                        .catch(function (error) {
                            console.error("Error removing item: ", error);
                        });
                    parentList.innerHTML = ""
                    onChildAdded(toDoListRef, (snapshot) => {
                        const newItem = snapshot.val();
                        renderToDoItem(newItem, snapshot.key);
                    });
                }
            }
        });
    </script>
</body>

</html>